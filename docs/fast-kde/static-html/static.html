<html lang="en" dir="ltr"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Fast &amp; Accurate Guassian Kernel Density Estimation</title>
    <meta property="og:title" content="Fast &amp; Accurate Guassian Kernel Density Estimation">
    <meta charset="utf-8">
    <meta property="og:type" content="article">


    <link rel="stylesheet" href="static/idyll_styles.css">
  <link id="idyll-equation-css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" rel="stylesheet" type="text/css" media="all"><style type="text/css">
                        .gridyll-control-container {
                            display: none;
                        }

                        img {
                            max-width: 100%;
                            max-height: 100%;
                            width: 100%;
                            margin: 6em auto 2em auto;
                        }
                    </style></head>
  <body><script id="__bs_script__">//<![CDATA[
    document.write("<script async src='/browser-sync/browser-sync-client.js?v=2.27.5'><\/script>".replace("HOST", location.hostname));
//]]></script><script async="" src="/browser-sync/browser-sync-client.js?v=2.27.5"></script>

    <div id="idyll-mount"><div><div class="idyll-root"><div class="article-header" style="background: rgb(255, 255, 255); color: rgb(51, 51, 51);"><h1 class="hed">Fast &amp; Accurate Guassian Kernel Density Estimation</h1><div class="byline">By: <a target="_blank" href="https://idl.cs.washington.edu" style="color: rgb(51, 51, 51);">Jeffrey Heer</a></div></div><div class=" idyll-text-container"><p>Kernel density estimation or kde powers visualizations such as violin plots heat maps and contour plots by modeling a discrete sample as a continuous distribution.</p><img src="static/images/kde-overview.png" alt="kde-overview"><p>For a set of input data points</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-0.png"></div><p>We represent each point with a kernel function.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-1.png"></div><p>We then sum the kernels to form a continuous density estimate. Here we focus on gaussian kernels which are commonly used in practice.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-2.png"></div><p>The spread of the kernels is determined by a bandwidth parameter for gaussian kernels this is just the standard deviation.</p><p>Unfortunately direct calculation is expensive. For each of <span style="display: inline-block;"><span> <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">m</span></span></span></span> </span></span> measurement points we must sum the contributions of the <span style="display: inline-block;"><span> <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">n</span></span></span></span> </span></span> data points resulting in quadratic complexity.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-3.png"></div><p>So how might we achieve fast yet accurate approximate estimates? One approach is to discretize the problem by binning the data.</p><p>KDE of <span style="display: inline-block;"><span> <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">n</span></span></span></span> </span></span> data points then reduces to a signal processing task smoothing a grid of <span style="display: inline-block;"><span> <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base"><span class="mord mathit">m</span></span></span></span> </span></span> bins.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-4.png"></div><p>With simple binning the weight of a data point is assigned to the nearest bin. If we perturb the points we can see how the weight is reassigned across bin boundaries</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-5.png"></div><p>Alternatively we can linearly interpolate weight across bins the weight is assigned proportionally providing some smoothing. We evaluate both of these binning methods.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-6.png"></div><p>Now a number of gaussian smoothing approaches exist for binned data. We focus on linear time methods that first bin the data an O(n) step and then make a bounded number of passes over the binned grid, an O(m) step.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-7.png"></div><p>The first method we’ll consider is box filtering which approximates gaussian smoothing by iteratively applying a uniform or box filter. We sum and scale the input values in the filter window to produce an output bin value.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-8.png"></div><p>We apply this running sum across the input grid writing results into an output grid.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-9.png"></div><p>To perform another iteration we first swap the input and output grids and then apply the box filter again. But note that the box filters can blur weight outside our original grid extent so box filter methods require grids with extra padding which may increase memory use and running time.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-10.png"></div><p>We perform our second iteration swap the grids again perform a third iteration and arrive at our density estimate.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-11.png"></div><p>Box filters are fast and easy to implement but they do have important nuances. We already saw how we must add padding to the grid but in addition the filter width, which is a function of bandwidth, can suffer from quantization error.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-12.png"></div><p>Here bandwidths of 0.1 and 0.15 both map to a box filter of width 3. The box filter results for the 2 will be indistinguishable.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-13.png"></div><p>Similarly here we get a filter width of 5 bins for bandwidths of both 0.2 and 0.25</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-14.png"></div><p>To address this, the extended box filter method adds fractional weight to the ends of the filter window. As the bandwidth varies the extended box varies the filter response more smoothly.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-15.png"></div><p>Finally let’s consider an approximation developed in the early 90s by Deriche <a title="Recursively implementating the Gaussian and its derivatives, Rachid Deriche" href="#references">[1]</a>, published in the signal processing literature. This method seems to have been overlooked by statistics and visualization researchers.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-16.png"></div><p>Deriche derived a recursive filter approximation for the right half of a gaussian with parameters he determined via optimization</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-17.png"></div><p>We can reverse the equation to model the left half of a gaussian and then sum the two filter responses.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-18.png"></div><p>The method runs in linear time but does involve more arithmetic operations than box filters.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-19.png"></div><p>So now let’s evaluate how these linear time methods fare in terms of accuracy.</p><p>We’ll start with an impulse test involving a single data point corresponding to a single gaussian density we can compare direct calculation with box filters and extended box filters and we see that both methods lead to underestimation of the peak and poor fit to the tails of the distribution.</p><p>Meanwhile the duresh method achieves high we must also inspect other bandwidth values in order to more systematically measure the error.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-20.png"></div><p>For each KDE method we measure the maximum pixel error for a 100 pixel tall density chart plotting the results on a logarithmic scale and do this across a range of bandwidths.</p><p>Here are the error curves for simple binning on a 256 bin grid we see oscillation in the box method due to filter quantization the extended box method smooths this out jarisha’s method outperforms the others and at high bandwidth it’s over an order of magnitude better with a maximum error around one pixel.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-21.png"></div><p>Switching to linear binning the duresh method improves with subpixel accuracy for most tested bandwidths</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-22.png"></div><p>If we double the number of bins darish improves further to near pixel perfect accuracy almost two orders of magnitude better than box filter methods.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-23.png"></div><p>Ultimately we care about real world data, so here’s an excerpt from the Palmer penguins data set showing an estimated density of penguin body mass at bandwidth 200. All methods appear to perform reasonably well however at lower bandwidths we see some significant discrepancies.</p><p>The box filter methods may misestimate peaks or erode local optima and in the language of algebraic vis these are hallucinators that is our choice of technique may mislead us with inaccurate visual features <a title="An algebraic process for visualization design, Gordon Kindlmann and Carlos Scheidegger" href="#references">[2]</a>.</p><p>So looking across bandwidths here are the results for simple binning with 256 bins. Again the duresh method provides the best performance.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-24.png"></div><p>Accuracy improves with linear binning...</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-25.png"></div><p>and the performance gap widens when doubling the number of bins.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-26.png"></div><p>So finally let’s examine 2d density estimation for heat maps and contour plots we’ll look at mileage versus horsepower in the classic cars data set.</p><p>Using direct calculation as a baseline we can visualize the difference in estimates when using box and extended box filtering. We again see that these methods tend to underestimate peaks yet overestimate the size of a distribution.</p><p>Errors from the duresh method however are imperceptibly low on this color scale. Now if we overlay contours from all three methods we’ll find that darice matches the ground truth while the box filter methods can incur missing contours missed estimated peaks and again other hallucinators</p><p>Across bandwidths we see that the duresh method is consistently better.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-27.png"></div><p>Once again this further improves by using linear binning and increasing the grid size.</p><div class="idyll-graphic"><img src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-graphic-28.png"></div><p>In conclusion we find that the combination of duresh’s approximation in linear binning provides high accuracy with a competitive linear running time. We recommend its use for one and two dimensional density visualizations.</p><p>There are some important limitations the method only supports gaussian kernels not other forms of kernel functions and it’s inherently a one-dimensional technique that is use across multiple dimensions requires separable independent axes.</p><div id="references"><h1>References</h1><ol><li><a target="_blank">Recursively implementating the Gaussian and its derivatives</a>, Rachid Deriche.<em> INRIA.</em> 1993.</li><li><a target="_blank">An algebraic process for visualization design</a>, Gordon Kindlmann and Carlos Scheidegger.<em> IEEE transactions on visualization and computer graphics.</em> 2014.</li></ol></div></div><div><div><h2 id="appendix-scene-6">Appendix Scene 6</h2><div class="appendix-graphic-container"><div><h3 id=""></h3><div class="appendix-graphic-plex"><img style="max-width: 100%;" src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-appendix-0.png"></div><div class="appendix-graphic-plex"><img style="max-width: 100%;" src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-appendix-1.png"></div><div class="appendix-graphic-plex"><img style="max-width: 100%;" src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-appendix-2.png"></div><div class="appendix-graphic-plex"><img style="max-width: 100%;" src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-appendix-3.png"></div><div class="appendix-graphic-plex"><img style="max-width: 100%;" src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-appendix-4.png"></div><div class="appendix-graphic-plex"><img style="max-width: 100%;" src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-appendix-5.png"></div><div class="appendix-graphic-plex"><img style="max-width: 100%;" src="/Users/mathisonian/projects/gridyll-examples/fast-kde/output/static/build/static/static-appendix-6.png"></div></div></div></div></div></div></div></div>
    <script src="static/idyll_index.js"></script>
  

</body></html>